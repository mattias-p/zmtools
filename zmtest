#!/bin/sh

bindir="`dirname $0`"

ZMB="$bindir/zmb"

usage_error () {
    message="$1"
    echo "$message" >&2
    exit 2
}

[ $# -ge 1 ] || usage_error "No domain specified"
domain="$1" ; shift

# Start test
testid="`"${ZMB}" start_domain_test "$domain" | jq -r .result`"

# Wait for test to finish
while true
do
    progress="`"${ZMB}" test_progress "$testid" | jq -r .result`"
    echo -n "\r$progress% done" >&2
    if [ "$progress" -eq 100 ] ; then
        echo >&2
        break
    fi
    sleep 1
done

# Get test results
"${ZMB}" get_test_results "$testid"
echo "testid:" $testid >&2
